x-redis-env: &redis-env
  REDIS_HOST: localhost
  REDIS_PORT: 6379

services:
  redis:
    image: "redis:alpine"
    container_name: ai_lb_redis
    restart: unless-stopped
    network_mode: host
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 3s
      retries: 10
      start_period: 10s
    # Use host network so containers can reach via host.docker.internal

  # Monitor is optional; enabled via profile "full"
  monitor:
    build:
      context: ./monitor
    container_name: ai_lb_monitor
    network_mode: host
    environment:
      <<: *redis-env
      # Hosts to scan for LMStudio or other upstreams
      SCAN_HOSTS: ${SCAN_HOSTS:-localhost:11434,localhost:9996,localhost:9995}
      SCAN_PORTS: ${SCAN_PORTS:-}
      SCAN_INTERVAL: ${SCAN_INTERVAL:-10}
      # Optional concurrency caps for the LB's LEAST_LOADED strategy
      DEFAULT_MAXCONN: ${DEFAULT_MAXCONN:-50}
      MAXCONN_MAP: ${MAXCONN_MAP:-}
    depends_on:
      - redis
    restart: unless-stopped
    profiles: ["full"]

  load_balancer:
    build:
      context: ./load_balancer
    container_name: ai_lb_load_balancer
    network_mode: host
    environment:
      <<: *redis-env
      # Routing/selection
      ROUTING_STRATEGY: ${ROUTING_STRATEGY:-P2C}
      REQUEST_TIMEOUT_SECS: ${REQUEST_TIMEOUT_SECS:-60}
      ATTEMPTS_PER_MODEL: ${ATTEMPTS_PER_MODEL:-3}
      RETRY_BACKOFF_MS: ${RETRY_BACKOFF_MS:-50,100}
      CIRCUIT_BREAKER_THRESHOLD: ${CIRCUIT_BREAKER_THRESHOLD:-3}
      CIRCUIT_BREAKER_COOLDOWN_SECS: ${CIRCUIT_BREAKER_COOLDOWN_SECS:-60}
      MODEL_SENTINELS: ${MODEL_SENTINELS:-auto,default}
      PREFERRED_MODELS: ${PREFERRED_MODELS:-}
      AUTO_MIN_NODES: ${AUTO_MIN_NODES:-2}
      STRICT_AUTO_MODE: ${STRICT_AUTO_MODE:-0}
      LM_PREFER_SMALL: ${LM_PREFER_SMALL:-1}
      CROSS_MODEL_FALLBACK: ${CROSS_MODEL_FALLBACK:-0}
      # Stickiness (only used when x-session-id present)
      STICKY_SESSIONS_ENABLED: ${STICKY_SESSIONS_ENABLED:-false}
      STICKY_TTL_SECS: ${STICKY_TTL_SECS:-600}
      # P2C tuning
      P2C_ALPHA: ${P2C_ALPHA:-0.5}
      P2C_PENALTY_WEIGHT: ${P2C_PENALTY_WEIGHT:-2.0}
      # Hedging
      HEDGING_ENABLED: ${HEDGING_ENABLED:-true}
      HEDGING_SMALL_MODELS_ONLY: ${HEDGING_SMALL_MODELS_ONLY:-true}
      HEDGING_MAX_DELAY_MS: ${HEDGING_MAX_DELAY_MS:-800}
      HEDGING_P95_FRACTION: ${HEDGING_P95_FRACTION:-0.6}
      # Eligibility thresholds
      MAX_P95_LATENCY_SECS: ${MAX_P95_LATENCY_SECS:-5.0}
      # Multi-backend execution
      MULTI_EXEC_ENABLED: ${MULTI_EXEC_ENABLED:-true}
      MULTI_EXEC_MAX_BACKENDS: ${MULTI_EXEC_MAX_BACKENDS:-3}
      MULTI_EXEC_TIMEOUT_SECS: ${MULTI_EXEC_TIMEOUT_SECS:-60}
      MULTI_EXEC_CONSENSUS_THRESHOLD: ${MULTI_EXEC_CONSENSUS_THRESHOLD:-0.9}
      BACKEND_ALIASES: ${BACKEND_ALIASES:-}
      MODEL_EQUIVALENTS: ${MODEL_EQUIVALENTS:-}
    depends_on:
      - redis
    restart: unless-stopped
    command: ["uvicorn", "load_balancer.main:app", "--host", "0.0.0.0", "--port", "8001"]
    # Port mapping not needed in host mode, app must bind to port directly
    # ports:
    #   - "${LOAD_BALANCER_PORT:-8000}:8000"

volumes:
  redis_data:
